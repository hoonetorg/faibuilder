#!/usr/bin/env -S python3 -u
import logging

import os
import sys
import subprocess
import shlex
import shutil

from pathlib import Path

import pwd
import grp

import json

BASEFILESDIRPATH = "/srv/fai/basefiles"
FAICONFIGDIRPATH = "/srv/fai/config"
FAIMIRRORDIRPATH = "/srv/fai/mirror"
FAINFSROOTDIRPATH = "/srv/fai/nfsroot"
OUTPUTDIRPATH = "/srv/fai/output"
HOSTCONF = "/srv/fai/host.json"


def subprocess_run_wrapper(
    cmd: str, dryrun: bool = False, **kwargs
) -> subprocess.CompletedProcess | None:
    if kwargs.get("shell"):
        wcmd = cmd
    else:
        wcmd = shlex.split(cmd)

    if dryrun:
        logging.info(f"[DRYRUN] {cmd}")
        return None

    logging.info(f"[EXECUTING] {cmd}")
    return subprocess.run(wcmd, **kwargs)


def get_path(path):
    return Path(path).expanduser().absolute()


def split_multi_ext(path: Path):
    suffixes = "".join(path.suffixes)
    if suffixes:
        stem = path.name[: -len(suffixes)]
        ext = suffixes.lstrip(".")
    else:
        stem = path.name
        ext = ""
    return stem, ext


def is_readable_file(file: Path) -> bool:
    return file.exists() and file.is_file() and os.access(file, os.R_OK)


def do_faimirror(faiclasses: list, faimirrordir: Path, dryrun: bool = False):
    faimirrormarker = faimirrordir / "mirror-is-up-to-date"

    logging.info("Checking mirror freshness")
    if not faimirrormarker.is_file():
        logging.info(
            f"Mirror is outdated or missing, faimirror marker file {shlex.quote(str(faimirrormarker))} is not a file — running fai-mirror"
        )

        subprocess_run_wrapper(
            cmd=(
                "fai-mirror -b -m1 "
                f"-c '{','.join(faiclasses)},GRUB_PC,GRUB_EFI,AMD64,FAIBUILDER' "
                f"{shlex.quote(str(faimirrordir))}"
            ),
            dryrun=dryrun,
        )

        if not dryrun:
            logging.info(
                f"Mirror finished, touching faimirror marker file: {shlex.quote(str(faimirrormarker))}"
            )
            faimirrormarker.touch()
    else:
        logging.info(
            f"Mirror is up to date, faimirror marker file is existing {shlex.quote(str(faimirrormarker))}"
        )


def do_make_basefile(
    basefilesdir: Path, basefile: Path, faiconfigdir: Path, dryrun: bool = False
):
    basefilefull = basefilesdir / basefile

    logging.info(f"Checking if basefile {shlex.quote(str(basefilefull))} exists")
    if not basefilefull.is_file():
        logging.info(
            f"Basefile {shlex.quote(str(basefilefull))} is outdated or missing - running mk-basefile"
        )

        basefilebase, basefileext = split_multi_ext(basefile)

        subprocess_run_wrapper(
            cmd=(
                f"{shlex.quote(str(faiconfigdir / 'basefiles' / 'mk-basefile'))} -J {shlex.quote(str(basefilebase))}"
            ),
            dryrun=dryrun,
            cwd=basefilesdir,
        )

    else:
        logging.info(f"Basefile {shlex.quote(str(basefilefull))} already exists")


def do_make_fainfsroot(
    fainfsrootdir: Path, basefilesdir: Path, basefile: Path, dryrun: bool = False
):
    fainfsrootmarker = fainfsrootdir / ".THIS_IS_THE_FAI_NFSROOT"

    basefilefull = basefilesdir / basefile

    logging.info("Checking NFSROOT freshness")
    if not fainfsrootmarker.is_file():
        logging.info(
            f"NFSROOT is outdated or missing fainfsroot marker file {shlex.quote(str(fainfsrootmarker))} is not a file — running fai-make-nfsroot"
        )

        hooksdir = Path("/etc/fai/nfsroot-hooks")

        logging.info(f"Creating {shlex.quote(str(hooksdir))}")
        hooksdir.mkdir(parents=True, exist_ok=True)

        src = Path("/usr/local/etc/50-add-btrfs")
        dest = hooksdir / src.name

        logging.info(
            f"Copying {shlex.quote(str(src))} to {shlex.quote(str(dest))} and make it executable"
        )
        shutil.copy2(src, dest)

        # chmod +x
        mode = dest.stat().st_mode
        dest.chmod(mode | 0o111)

        logging.info(
            f"Content of {shlex.quote(str(dest))}:\n{str(dest.read_text(encoding='utf-8'))}"
        )

        subprocess_run_wrapper(
            cmd=(f"fai-make-nfsroot -B {shlex.quote(str(basefilefull))} -N -f -v"),
            dryrun=dryrun,
        )

    else:
        logging.info(
            f"NFSROOT seems to be ready - fainfsroot marker file {shlex.quote(str(fainfsrootmarker))} already exists"
        )


def do_build_iso(
    faiclasses: list,
    hostconf: dict,
    faiconfigdir: Path,
    faimirrordir: Path,
    outputdir: Path,
    dryrun: bool = False,
):

    classesfile = faiconfigdir / "class" / "50-host-classes"

    keymap = str(hostconf["keymap"])
    timezone = str(hostconf["timezone"])
    rootpw = str(hostconf["rootpw"])
    username = str(hostconf["username"])
    userpw = str(hostconf["userpw"])
    diskpath = Path(hostconf["diskpath"])
    rootsizemib = int(hostconf["rootsizemib"])
    outfile = Path(hostconf["outfile"])

    outfilefull = outputdir / outfile

    logging.info(f"Building FAI ISO {shlex.quote(str(outfilefull))}  with faicd")

    logging.info("hostconf:")
    logging.info(f"keymap: {str(keymap)}")
    logging.info(f"timezone: {str(timezone)}")
    logging.info("rootpw: hidden")
    logging.info(f"username: {str(username)}")
    logging.info("userpw: hidden")
    logging.info(f"diskpath: {shlex.quote(str(diskpath))}")
    logging.info(f"rootsizemib: {int(rootsizemib)}")
    logging.info(f"outfile: {shlex.quote(str(outfile))}")

    content = (
        "#!/bin/bash\n"
        "# generated by faibuilder\n"
        f"echo '{' '.join(faiclasses)} FAIBUILDER'\n"
    )
    if dryrun:
        logging.info(
            f"[DRYRUN] Would write to {shlex.quote(str(classesfile))}:\n{content.strip()}"
        )
    else:
        logging.info(f"Writing to {shlex.quote(str(classesfile))}:\n{content.strip()}")
        classesfile.write_text(content)

    logging.info(f"Making {shlex.quote(str(classesfile))} executable")
    classesfilemode = classesfile.stat().st_mode
    classesfile.chmod(classesfilemode | 0o111)

    variablesfile = faiconfigdir / "class" / "FAIBUILDER.var"
    content = (
        "# generated by faibuilder\n"
        f"KEYMAP='{str(keymap)}'\n"
        f"TIMEZONE='{str(timezone)}'\n"
        f"ROOTPW={shlex.quote(str(rootpw))}\n"
        f"username='{str(username)}'\n"
        f"USERPW={shlex.quote(str(userpw))}\n"
        f"DISKPATH={shlex.quote(str(diskpath))}\n"
        f"ROOTSIZEMIB='{int(rootsizemib)}'\n"
    )

    if dryrun:
        logging.info(
            f"[DRYRUN] Would write to {shlex.quote(str(variablesfile))}\n{content.strip()}"
        )
    else:
        logging.info(f"Writing to {shlex.quote(str(variablesfile))}\n{content.strip()}")
        variablesfile.write_text(content)

    # logging.info(f"Making {shlex.quote(str(variablesfile))} executable")
    # variablesfilemode = variablesfile.stat().st_mode
    # variablesfile.chmod(variablesfilemode | 0o111)

    subprocess_run_wrapper(
        cmd=(
            "fai-cd "
            f"-g {shlex.quote(str(faiconfigdir / 'grub.cfg'))} "
            f"-m {shlex.quote(str(faimirrordir))} "
            f"{shlex.quote(str(outfilefull))}"
        ),
        dryrun=dryrun,
    )


def do_build_img_from_iso(
    isofilefull: Path,
    dryrun: bool = False,
):

    imgfilefull = isofilefull.with_suffix(".img")
    logging.info(
        f"Creating IMG file {shlex.quote(str(imgfilefull))} from ISO file {shlex.quote(str(isofilefull))}"
    )

    # MAX_FAT32_FILESIZE_BYTES = 4 * 1024**3  # 4 GiB in MiB
    # MAX_FAT32_FILESIZE_MIB = MAX_FAT32_FILESIZE_BYTES / (1024**2)

    if not is_readable_file(file=isofilefull):
        logging.error(
            f"\nISO file {shlex.quote(str(isofilefull))} does not exist - Exiting"
        )
        sys.exit(1)

    logging.info(f"Processing file: {shlex.quote(str(isofilefull))}")

    isopath = Path("/iso")
    efipath = Path("/efi")
    cdpath = Path("/cd")

    for p in {isopath, efipath, cdpath}:
        p.mkdir(parents=True, exist_ok=True)

    imagesizegb = 3
    efilabel = "EFI"
    cdlabel = "FAI_CD"

    logging.info("Mounting ISO contents")
    subprocess_run_wrapper(
        cmd=(
            f"mount -o loop,ro {shlex.quote(str(isofilefull))} {shlex.quote(str(isopath))}"
        ),
        dryrun=dryrun,
    )

    logging.info("Creating disk image")
    subprocess_run_wrapper(
        cmd=(
            f"qemu-img create -f raw -o preallocation=off {shlex.quote(str(imgfilefull))} {int(imagesizegb)}G"
        ),
        dryrun=dryrun,
    )

    logging.info("Partitioning the disk")
    subprocess_run_wrapper(
        cmd=(
            "parted --script "
            f"{shlex.quote(str(imgfilefull))} "
            "mklabel gpt "
            "mkpart primary fat32 1MiB 125MiB "
            "mkpart primary ext4 125MiB 100%"
        ),
        dryrun=dryrun,
    )

    logging.info("Mapping partitions")
    try:
        result = subprocess_run_wrapper(
            cmd=(f"losetup --show -fP {shlex.quote(str(imgfilefull))}"),
            dryrun=dryrun,
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE,
            text=True,
            check=True,
        )

        loopdevice = Path(result.stdout.strip())
        logging.info(f"loopdevice:\n{shlex.quote(str(loopdevice))}")
    except subprocess.CalledProcessError as err:
        logging.error(f"losetup failed: {err.stderr}")
        sys.exit(1)

    subprocess_run_wrapper(
        cmd=(f"kpartx -av {shlex.quote(str(loopdevice))}"),
        dryrun=dryrun,
    )

    part1 = Path("/dev/mapper") / (loopdevice.name + "p1")
    part2 = Path("/dev/mapper") / (loopdevice.name + "p2")

    logging.info("Formatting and mounting partitions")

    subprocess_run_wrapper(
        cmd=(f"mkfs.vfat -F 32 -n {efilabel} {shlex.quote(str(part1))}"),
        dryrun=dryrun,
    )
    subprocess_run_wrapper(
        cmd=(f"mount {shlex.quote(str(part1))} {shlex.quote(str(efipath))}"),
        dryrun=dryrun,
    )
    # subprocess_run_wrapper(
    #     cmd=(f"mkfs.ext4 -L {cdlabel} {shlex.quote(str(part2))}"),
    #     dryrun=dryrun,
    # )
    subprocess_run_wrapper(
        cmd=(
            f"mkfs.btrfs --data single --metadata dup -L {cdlabel} {shlex.quote(str(part2))}"
        ),
        dryrun=dryrun,
    )
    subprocess_run_wrapper(
        cmd=(f"mount {shlex.quote(str(part2))} {shlex.quote(str(cdpath))}"),
        dryrun=dryrun,
    )

    subprocess_run_wrapper(
        cmd=(
            "grub-install "
            f"--efi-directory={shlex.quote(str(efipath))} "
            f"--boot-directory={shlex.quote(str(efipath))} "
            "--target=x86_64-efi "
            "--no-nvram "
            "--removable "
            "--uefi-secure-boot "
        ),
        dryrun=dryrun,
    )

    subprocess_run_wrapper(
        cmd=(
            "rsync "
            "-av "
            "--exclude=EFI/ "
            f"{shlex.quote(str(isopath) + '/')} "
            f"{shlex.quote(str(cdpath) + '/')}"
        ),
        dryrun=dryrun,
    )

    (efipath / "EFI" / "BOOT").mkdir(parents=True, exist_ok=True)

    subprocess_run_wrapper(
        cmd=(
            "rsync "
            "-av "
            "/usr/local/etc/grub.cfg "
            f"{shlex.quote(str(efipath / 'EFI' / 'BOOT'))} "
        ),
        dryrun=dryrun,
    )

    # find_files(efipath, output_file=f"{imgfilefull}.filelistefi")

    subprocess_run_wrapper(
        cmd=(f"umount {shlex.quote(str(efipath))}"),
        dryrun=dryrun,
    )

    # find_files(cdpath, output_file=f"{imgfilefull}.filelistcd")

    subprocess_run_wrapper(
        cmd=(f"umount {shlex.quote(str(cdpath))}"),
        dryrun=dryrun,
    )

    logging.info("Cleaning up")
    subprocess_run_wrapper(
        cmd=(f"kpartx -d {shlex.quote(str(loopdevice))}"),
        dryrun=dryrun,
    )

    subprocess_run_wrapper(
        cmd=(f"losetup -d {shlex.quote(str(loopdevice))}"),
        dryrun=dryrun,
    )

    subprocess_run_wrapper(
        cmd=(f"umount {shlex.quote(str(isopath))}"),
        dryrun=dryrun,
    )

    logging.info(f"Disk image {imgfilefull} created successfully")


def main():
    dryrun = False
    logging.basicConfig(level=logging.INFO, format="[%(levelname)s] %(message)s")

    basefilesdir = get_path(BASEFILESDIRPATH)
    faiconfigdir = get_path(FAICONFIGDIRPATH)
    faimirrordir = get_path(FAIMIRRORDIRPATH)
    fainfsrootdir = get_path(FAINFSROOTDIRPATH)
    outputdir = get_path(OUTPUTDIRPATH)

    logging.info(f"basefilesdir: {shlex.quote(str(basefilesdir))}")
    logging.info(f"faiconfigdir: {shlex.quote(str(faiconfigdir))}")
    logging.info(f"faimirrordir: {shlex.quote(str(faimirrordir))}")
    logging.info(f"fainfsrootdir: {shlex.quote(str(fainfsrootdir))}")
    logging.info(f"outputdir: {shlex.quote(str(outputdir))}")

    # 0
    root_uid = pwd.getpwnam("root").pw_uid
    root_gid = grp.getgrnam("root").gr_gid

    for d in [basefilesdir, faimirrordir, fainfsrootdir, outputdir]:
        if d.exists():
            os.chown(d, root_uid, root_gid)
            d.chmod(0o755)
        else:
            logging.info(f"[WARN] Directory does not exist: {shlex.quote(str(d))}")

    hostconffile = get_path(HOSTCONF)
    if not is_readable_file(file=hostconffile):
        logging.error(
            f"Config file not found or not readable: {shlex.quote(str(hostconffile))}"
        )
        sys.exit(1)
    logging.info(f"hostconffile: {shlex.quote(str(hostconffile))}")
    hostconf = json.loads(hostconffile.read_text(encoding="utf-8"))
    logging.info(f"hostconf:\n{json.dumps(hostconf, indent=2)}")

    faiclasses = hostconf["faiclasses"]
    basefile = Path(hostconf["basefile"])
    outfile = Path(hostconf["outfile"])

    logging.info(f"faiclasses: {faiclasses}")
    logging.info(f"basefile: {shlex.quote(str(basefile))}")

    do_faimirror(faiclasses=faiclasses, faimirrordir=faimirrordir, dryrun=dryrun)
    do_make_basefile(
        basefilesdir=basefilesdir,
        basefile=basefile,
        faiconfigdir=faiconfigdir,
        dryrun=dryrun,
    )
    do_make_fainfsroot(
        fainfsrootdir=fainfsrootdir,
        basefilesdir=basefilesdir,
        basefile=basefile,
        dryrun=dryrun,
    )
    do_build_iso(
        faiclasses=faiclasses,
        hostconf=hostconf,
        faiconfigdir=faiconfigdir,
        faimirrordir=faimirrordir,
        outputdir=outputdir,
        dryrun=dryrun,
    )

    do_build_img_from_iso(
        isofilefull=outputdir / outfile,
        dryrun=dryrun,
    )


if __name__ == "__main__":
    main()
